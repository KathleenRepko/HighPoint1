BrightTag.site('BirQ92C',function(s){
s.domready(function(){
s.tag('\x3cscript class\x3d\x22kxct\x22 data-id\x3d\x22q2gj9ap4s\x22 data-timing\x3d\x22async\x22 data-version\x3d\x222.0\x22 type\x3d\x22text/javascript\x22\x3e\n\n//Begin Krux ControlTag\n  function kruxControl(){\n      window.Krux||((Krux\x3dfunction(){Krux.q.push(arguments)}).q\x3d[]);\n      (function(){\n      var k\x3ddocument.createElement(\x27script\x27);k.type\x3d\x27text/javascript\x27;k.async\x3dtrue;\n      var m,src\x3d(m\x3dlocation.href.match(/\\bkxsrc\x3d([^\x26]+)/))\x26\x26decodeURIComponent(m[1]);\n      k.src \x3d /^https?:\\/\\/([a-z0-9_\\-\\.]+\\.)?krxd\\.net(:\\d{1,5})?\\/controltag\\//i.test(src) ? src : src \x3d\x3d\x3d \x22disable\x22 ? \x22\x22 :\n        (location.protocol\x3d\x3d\x3d\x22https:\x22?\x22https:\x22:\x22http:\x22)+\x22//cdn.krxd.net/controltag?confid\x3dq2gj9ap4s\x22;\n      var s\x3ddocument.getElementsByTagName(\x27script\x27)[0];s.parentNode.insertBefore(k,s);\n    }());\n  }\n\n// self defined function\nif(!String.prototype.startsWith) {\n    String.prototype.startsWith \x3d function(searchString, position){\n        position \x3d position || 0;\n        return this.substr(position, searchString.length) \x3d\x3d\x3d searchString;\n  };\n}\n\n// object.watch\nif(!Object.prototype.watch){\n    Object.defineProperty(Object.prototype, \x27watch\x27, {\n        value: function(prop, handler){\n            var setter \x3d function(val){\n                return val \x3d handler.call(this, val);\n            };\n            Object.defineProperty(this, prop, {\n                set: setter\n            });\n        }\n    });\n}\n\n//Begin Content Attribute Collection\nvar PAGE_CONTENT_MAP \x3d new Map();\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/member/, \x27Index\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/store\\/checkout/, \x27Cart\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/deals\\/search#.*page.*/, \x27Deals\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/deals\\/search#.*[category | keyword].*page.*/, \x27Offers search\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/member\\/store\\/.*[^reviews]/, \x27Store\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/member\\/store\\/.*\\/reviews/, \x27Review\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/member\\/offers/, \x27Offers\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/search/, \x27Provider Search\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/www.angieslist.com\\/articles/, \x27General Content\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/(projects|leadfeed-stage4).angieslist.com/, \x27Quote Request\x27);\nPAGE_CONTENT_MAP.set(/https:\\/\\/.*.angieslist.com\\/store\\/summary/, \x27Confirm\x27);\n\nvar category_menu \x3d document.querySelectorAll(\x27.dropdown-menu[data-reactid \x3d \x22.0.2.0.0.1.0.$1\x22]\x27)[0];\nif(typeof category_menu !\x3d \x27undefined\x27){\n  category_menu.onclick \x3d function(event) {\n      $(window).unbind();\n      $(window).bind(\x27hashchange\x27, function() {\n          categoryTracker(); \n      });  \n  };\n}\n\nvar dataLayer \x3d [];\n\n//End ControlTag Begin Encryption\nvar sjcl \x3d document.createElement(\x27script\x27);\nsjcl.src \x3d \x22https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.6/sjcl.min.js\x22;\ndocument.getElementsByTagName(\x27head\x27)[0].appendChild(sjcl);\nsjcl.onload \x3d categoryTracker;  \n\nfunction categoryTracker(){\n    \n    dataLayer.length \x3d 0;\n\n    //userid\n    var userId;\n    var obj \x3d {}; obj.status \x3d false;\n    var timer \x3d 1;\n    var interval \x3d setInterval(function(){\n          timer++;\n          if(timer \x3e\x3d 4){\n              clearInterval(interval);\n              userId \x3d undefined || localStorage.getItem(\x27userId\x27);\n              if(obj.status){\n                    pushDataLayer();\n                    kruxControl();\n              }else{\n                    obj.watch(\x27status\x27, function(value){\n                          pushDataLayer();\n                          kruxControl();\n                    });\n              }\n          }\n          else if(typeof config !\x3d \x27undefined\x27){\n              clearInterval(interval);\n              userId \x3d window.config.userId || config.user.attributes.userId;\n              localStorage.setItem(\x27userId\x27, window.config.userId);\n              if(obj.status){\n                    pushDataLayer();\n                    kruxControl();\n              }else{\n                    obj.watch(\x27status\x27, function(value){\n                          pushDataLayer();\n                          kruxControl();\n                    });\n              }\n         }\n    },500);\n\n    //extract service category list\n    var category_menu \x3d document.querySelectorAll(\x27.dropdown-menu[data-reactid \x3d \x22.0.2.0.0.1.0.$1\x22]\x27)\n    var category_menu_array \x3d (category_menu.length !\x3d 0)?category_menu[0].querySelectorAll(\x22li\x22):[];\n    var serviceCategory_array \x3d [];\n    var service_id,service_item;\n    for(let i \x3d 0; i \x3c category_menu_array.length; i++){\n        var li_category_id \x3d category_menu_array[i].getAttribute(\x27data-reactid\x27);\n         \n          service_id \x3d li_category_id.slice(li_category_id.lastIndexOf(\x22$\x22)+1);\n          service_item \x3d category_menu_array[i].querySelectorAll(\x27span\x27)[1].textContent\n          serviceCategory_array.push({\n               serviceCategory_id: service_id,\n               serviceCategory: service_item\n          });      \n          localStorage.setItem(\x27serviceCategoryReference\x27, JSON.stringify(serviceCategory_array));\n    }\n    \n    //extract service category code from url\n    var url \x3d document.URL;\n    var parameter \x3d url.split(\x27#\x27)[1] || url.split(\x27?\x27)[1];\n    var parameter_array \x3d (parameter \x3d\x3d undefined)?[]:parameter.split(\x27\x26\x27);\n    var serviceCategory,category,queryString;\n    var previousPage_category \x3d localStorage.getItem(\x27url_category\x27);\n    var previousPage_queryString \x3d localStorage.getItem(\x27url_queryString\x27);\n    \n    for(let i \x3d 0;i \x3c parameter_array.length;i++){\n      if(parameter_array[i].startsWith(\x27category\x27)){\n          category \x3d parameter_array[i].split(\x27\x3d\x27)[1];\n      }else if(parameter_array[i].startsWith(\x27query\x27)){\n          queryString \x3d parameter_array[i].split(\x27\x3d\x27)[1];\n      }\n    }\n    \n    localStorage.setItem(\x27url_category\x27, category);\n    localStorage.setItem(\x27url_queryString\x27, queryString);\n\n    var serviceCategory_json \x3d localStorage.getItem(\x27serviceCategoryReference\x27);\n    var serviceCategory_json_array;\n    var notFound \x3d true;\n\n    if(category !\x3d undefined){\n        if(serviceCategory_json){\n            serviceCategory_json_array \x3d JSON.parse(serviceCategory_json);\n            for(let i \x3d 0; i \x3c serviceCategory_json_array.length; i++){\n               if(serviceCategory_json_array[i].serviceCategory_id \x3d\x3d category){\n                       serviceCategory \x3d serviceCategory_json_array[i];\n                       notFound \x3d false;\n               }\n            }\n        }\n        if(notFound){\n                    serviceCategory \x3d {};\n                    serviceCategory.serviceCategory_id \x3d category;\n                    serviceCategory.serviceCategory \x3d queryString;\n        }\n    }\n\n    //extract content Type\n    var contentType; \n\n    PAGE_CONTENT_MAP .forEach(function (value, key) {\n       if(key.test(url)){\n          contentType \x3d value;\n       }\n    });\n    \n    //extract order Number\n    var orderNumber \x3d (localStorage.orderNumber)?localStorage.orderNumber:undefined; \n    var orderNumber_array;\n\n    //test page\n    if(url.split(\x27?\x27)[1]){\n        orderNumber_array \x3d url.split(\x27?\x27)[1].split(\x27\x26\x27);\n        orderNumber_array.forEach(function(item,index){\n                if(item.startsWith(\x27paymentIdString\x27)){\n                     orderNumber \x3d item.split(\x27\x3d\x27)[1];\n                     if(localStorage.orderNumber !\x3d orderNumber){\n                                  localStorage.orderNumber \x3d orderNumber;\n                     }\n                }\n        })\n    }\n    \n    //extract products lists\n    var products_list \x3d new Array();\n    var productList,product;\n    var localStorageData \x3d \x27\x27;\n    \n    //checkout page\n    if(typeof segmentIoData !\x3d \x27undefined\x27){\n        \n        serviceCategory \x3d {};         \n        serviceCategory.serviceCategory \x3d [];\n        serviceCategory.serviceCategory_id \x3d [];\n        \n        segmentIoData.skuItems.forEach(function(item,index){\n            product \x3d new Object();\n            product.productName \x3d item.skuTitle;\n            product.provider \x3d item.companyName;\n            product.category \x3d item.skuCategory;\n            product.categoryName \x3d item.skuCategoryName;\n            product.quantity \x3d (localStorage.quantListArr)?Number(localStorage.quantListArr.split(\x27,\x27)[index]):undefined;\n\n            product.price \x3d  (localStorage.itemPriArr)?Number(localStorage.itemPriArr.split(\x27,\x27)[index]):undefined;\n            \n            serviceCategory.serviceCategory.push(item.skuCategoryName);\n            serviceCategory.serviceCategory_id.push(item.skuCategory);\n            \n            //test page\n            product.price \x3d Number($(\x27.discountedPrice\x27)[index].innerHTML.split(\x27$\x27)[1]);\n           \n            product.productid \x3d item.skuId;\n            products_list.push(product);\n        })\n\n            localStorage.setItem(\x27products_list\x27, JSON.stringify(products_list));\n    }\n\n    var products_list, confirm_page, confirm_page_array, count;\n    if(contentType \x3d\x3d \x22Confirm\x22){\n\n        products_list \x3d JSON.parse(localStorage.getItem(\x27products_list\x27));\n        confirm_page \x3d [].slice.call($(\x27.StorefrontThankYouOrderTotals tbody\x27));\n        confirm_page_array \x3d [];\n        count;\n\n        serviceCategory \x3d {};         \n        serviceCategory.serviceCategory \x3d [];\n        serviceCategory.serviceCategory_id \x3d [];\n\n        confirm_page.forEach(function(item){\n              confirm_page_array.push(item.querySelector(\x27.itemName\x27).textContent);\n        })\n        \n        if(products_list){\n              products_list.forEach(function(item,index,array){\n                    count \x3d 0;\n                    for(var i \x3d 0 ; i \x3c confirm_page_array.length; i++){\n                               if(item.productName \x3d\x3d confirm_page_array[i]){\n                                    count++;\n                               }\n                    }\n                    if(count \x3d\x3d 0){\n                        products_list.splice(index,1);\n                    }else{\n                        item.quantity \x3d count;           \n                           serviceCategory.serviceCategory.push(item.categoryName);\n                           serviceCategory.serviceCategory_id.push(item.category);\n                    }\n              })\n        }\n    }\n\n    //store products into datalayer\n    var products \x3d JSON.parse(localStorage.getItem(\x27products\x27));\n    \n    //email hash \x26 alid\n    var user_traits_array,handle,alid,handle_cipher,hash;\n    if(localStorage.ajs_user_traits){\n        user_traits_array \x3d localStorage.ajs_user_traits.split(\x27,\x27);\n        user_traits_array.forEach(function(item){\n              if(item.indexOf(\x27email\x27) !\x3d -1){\n                let email \x3d item.split(\x27:\x27)[1];\n                let first_quotation \x3d email.indexOf(\x27\x22\x27);\n                let last_quotation \x3d email.lastIndexOf(\x27\x22\x27);\n                handle \x3d email.slice(first_quotation + 1, last_quotation - email.length);\n              }\n              if(item.indexOf(\x27ALID\x27) !\x3d -1){\n                let al \x3d item.split(\x27:\x27)[1];\n                let first_quotation \x3d al.indexOf(\x27\x22\x27);\n                let last_quotation \x3d al.lastIndexOf(\x27\x22\x27);\n                if(last_quotation \x3d\x3d -1){\n                  alid \x3d al.slice(first_quotation + 1, last_quotation);\n                }else{\n                    alid \x3d al.slice(first_quotation + 1, last_quotation - al.length);\n                }\n              }\n        })\n\n        if(typeof sjcl.hash !\x3d \x27undefined\x27 \x26\x26 typeof handle !\x3d \x27undefined\x27){\n\n            handle_cipher \x3d sjcl.hash.sha256.hash(handle);\n            hash \x3d sjcl.codec.hex.fromBits(handle_cipher);\n        }\n    }\n    \n    //project page\n    var select_service, select_quick;\n    if(contentType \x3d\x3d \x22Quote Request\x22){\n                \n        serviceCategory \x3d {};\n        serviceCategory.serviceCategory_id \x3d localStorage.getItem(\x27quote_item\x27);\n        serviceCategory.serviceCategory \x3d localStorage.getItem(\x27quote_item_id\x27);\n        \n        select_service \x3d document.querySelectorAll(\x27select[name\x3d\x22category.categoryId\x22]\x27)[0];\n        select_quick \x3d document.querySelectorAll(\x27select[name\x3d\x22urgency\x22]\x27)[0];\n        \n        if(typeof select_service !\x3d \x27undefined\x27){\n            select_service.addEventListener(\x27change\x27,function(e){\n                localStorage.setItem(\x27quote_item\x27,this.options[this.selectedIndex].text);\n                localStorage.setItem(\x27quote_item_id\x27,this.value);\n            })\n        }\n        \n        if(typeof select_quick !\x3d \x27undefined\x27){\n            select_quick.addEventListener(\x27change\x27,function(e){\n                localStorage.setItem(\x27quote_item_quick\x27,this.options[this.selectedIndex].text);\n            })\n        }  \n    }\n    \n    var quote_obj \x3d {};\n    quote_obj[\x27quote_item\x27] \x3d  localStorage.getItem(\x27quote_item\x27);\n    quote_obj[\x27quote_item_id\x27] \x3d  localStorage.getItem(\x27quote_item_id\x27);\n    quote_obj[\x27quote_item_quick\x27] \x3d  localStorage.getItem(\x27quote_item_quick\x27);\n\n    //offer page\n    var intentionProducts \x3d {};\n    var previousPage,previousPage_parameter,previousPage_parameter_array;\n    var reviewCategory;\n    var reviewCategory_array \x3d [];\n    var reviewCategory_counts \x3d {};\n    var max_value \x3d 0;\n    var reviewCategory_index;\n\n    if(contentType \x3d\x3d \x22Offers\x22){\n        \n             var offer_interval \x3d setInterval(function() {\n                  if(document.querySelectorAll(\x27p.offer-grades-sp-location\x27)[0] \x26\x26 document.querySelectorAll(\x27li.review-card_property-categoryOnCard\x27)[0]) {\n                        clearInterval(offer_interval);\n                        // get location\n                        var geo_location \x3d document.querySelectorAll(\x27p.offer-grades-sp-location\x27)[0].textContent.trim();\n                        var geo \x3d {};\n              \n                        intentionProducts.geo \x3d geo;\n                        geo.zip \x3d geo_location.slice(-5);\n                        geo.location \x3d geo_location.slice(0,-6);\n                        // price productname provider\n                        intentionProducts.price \x3d document.querySelectorAll(\x27.amount\x27)[0].textContent;\n                        intentionProducts.productname \x3d document.querySelectorAll(\x27.offer_title\x27)[0].textContent;\n                        intentionProducts.provider \x3d document.querySelectorAll(\x27.offer_sp\x3espan\x27)[0].textContent.split(\x27:\x27)[1].trim();\n\n                        if(previousPage_category !\x3d \x27undefined\x27){\n                            \n                            if(serviceCategory_json){\n\n                                serviceCategory_json_array \x3d JSON.parse(serviceCategory_json);\n                                \n                                for(let i \x3d 0; i \x3c serviceCategory_json_array.length; i++){\n                                   if(serviceCategory_json_array[i].serviceCategory_id \x3d\x3d previousPage_category){\n                                           intentionProducts.serviceCategory \x3d serviceCategory_json_array[i];\n                                           serviceCategory \x3d serviceCategory_json_array[i];\n                                   }\n                                }\n                            }                  \n\n                        }else{\n                            // get category\n                            reviewCategory \x3d document.querySelectorAll(\x27li.review-card_property-categoryOnCard\x27);\n                            reviewCategory.forEach(function(item){\n                                var reviewCategoryContent \x3d item.querySelectorAll(\x27strong\x27)[0].textContent;\n                                var temp_array \x3d reviewCategoryContent.split(\x27,\x27);\n                                temp_array.forEach(function(element){\n                                    reviewCategory_array.push(element.trim());\n                                })\n                            })\n                            \n                            for(var i \x3d 0; i\x3c reviewCategory_array.length; i++) {\n                                var num \x3d reviewCategory_array[i];\n                                reviewCategory_counts[num] \x3d reviewCategory_counts[num] ? reviewCategory_counts[num]+1 : 1;\n                            }\n\n                            for (key in reviewCategory_counts) {\n                                if(reviewCategory_counts[key] \x3e max_value){\n                                    reviewCategory_index \x3d key;\n                                    max_value \x3d reviewCategory_counts[key];\n                                }\n                            }\n                            \n                            notFound \x3d true;\n                            \n                            if(serviceCategory_json){\n\n                                serviceCategory_json_array \x3d JSON.parse(serviceCategory_json);\n                                \n                                for(let i \x3d 0; i \x3c serviceCategory_json_array.length; i++){\n\n                                   if(serviceCategory_json_array[i].serviceCategory \x3d\x3d reviewCategory_index){\n                                          intentionProducts.serviceCategory \x3d serviceCategory_json_array[i];\n                                          serviceCategory \x3d serviceCategory_json_array[i];\n                                          notFound \x3d false;\n                                   }\n                                }\n                            }\n\n                            if(notFound){\n                                serviceCategory \x3d {};\n                                serviceCategory.serviceCategory \x3d reviewCategory_index;\n                                serviceCategory.serviceCategory_id \x3d undefined;\n                                \n                                intentionProducts.serviceCategory \x3d {};\n                                intentionProducts.serviceCategory.serviceCategory \x3d reviewCategory_index;\n                                intentionProducts.serviceCategory.serviceCategory_id \x3d undefined;            \n                            }      \n                        }\n                        \n                        obj.status \x3d true;\n                  }  \n              }, 100);     \n\n    }else{\n          obj.status \x3d true;\n    }\n    \n    function pushDataLayer(){\n        dataLayer.push({\n            \x27page\x27:{\n                  \x22content-type\x22:contentType,\n                  \x22service-category\x22:serviceCategory, \n                  \x22order-number\x22:orderNumber, \n                  \x27products\x27: products,  \n                  \x27quote\x27: quote_obj,\n                  \x27service_viewed\x27: intentionProducts\n              },\n            \x27user\x27: {\n                \x22userID\x22: userId,             \n                \x22ALID\x22: alid,                                             \n                \x22email\x22:hash                     \n              }\n        });\n    }\n    kruxControl();\n};\n\n\x3c/script\x3e',{tagId:4444372});
});
});
